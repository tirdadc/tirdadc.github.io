<!doctype html>
<html>
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Practical use of JSONB attributes in Ruby on Rails forms</title>

    <link href='//fonts.googleapis.com/css?family=Open+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

    <link href="/stylesheets/site.css" rel="stylesheet" />
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
  </head>

  <div class="blog blog_2016 blog_2016_11 blog_2016_11_03 blog_2016_11_03_practical-use-of-jsonb-attributes-in-ruby-on-rails-forms blog_2016_11_03_practical-use-of-jsonb-attributes-in-ruby-on-rails-forms_index">
    <div class="header">
      <h1><a href='/'>tirdadc</a></h1>
      <h2>Web Development | Ruby on Rails | React.js</h2>
    </div>
    <article>
      <h3>Practical use of JSONB attributes in Ruby on Rails forms</h3>
      <time>Nov  3 2016</time>
      <div class="tags">
          <a href="/blog/categories/ruby-on-rails/">Ruby On Rails</a>
          <a href="/blog/categories/postgres/">Postgres</a>
      </div>
      <p>As you probably already know by now, Postgres 9.4 introduced JSONB as a new column type, effectively allowing you to use it both as a relational database and a full-fledged indexed and queryable document store when needed instead of trying to shoehorn everything into the latter and then dealing with the inevitable aftermath. Ruby on Rails has provided support for JSONB since <a href="http://guides.rubyonrails.org/4_2_release_notes.html">4.2</a>.</p>

<p>There&rsquo;s already a <a href="https://blog.codeship.com/unleash-the-power-of-storing-json-in-postgres/">solid</a> <a href="http://nandovieira.com/using-postgresql-and-jsonb-with-ruby-on-rails">amount</a> of <a href="http://robertbeene.com/rails-4-2-and-postgresql-9-4/">blog</a> posts out there on this topic, so this one aims to focus on a practical aspect of implementing it.</p>

<p>Start off by adding an indexed JSONB field to your table:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">AddWebsitesToUser</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:websites</span><span class="p">,</span> <span class="ss">:jsonb</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'{}'</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:websites</span><span class="p">,</span> <span class="ss">using: :gin</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Now you can set whatever data you want inside of that field using keys:</p>
<pre class="highlight ruby"><code><span class="n">user</span><span class="p">.</span><span class="nf">websites</span><span class="p">[</span><span class="s1">'primary_website'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'http://www.example.com'</span>
</code></pre>
<p>Using a store accessor allows you to specify the keys you want to access directly without referencing the JSONB field:</p>
<pre class="highlight ruby"><code><span class="c1"># user.rb</span>
<span class="n">store_accessor</span> <span class="ss">:websites</span><span class="p">,</span> <span class="ss">:primary_website</span><span class="p">,</span> <span class="ss">:secondary_website</span><span class="p">,</span> <span class="ss">:optional_website</span>
</code></pre>
<p>Which allows you to do this:</p>
<pre class="highlight ruby"><code><span class="n">user</span><span class="p">.</span><span class="nf">primary_website</span>
<span class="c1">#=&gt; 'http://wwww.example.com'</span>
</code></pre>
<p>Your client <code>_form.html.erb</code> can then treat these as regular fields:</p>
<pre class="highlight erb"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:primary_website</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:primary_website</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:secondary_website</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:secondary_website</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:optional_website</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:optional_website</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
<p>Be sure to whitelist them as usual in the controller:</p>
<pre class="highlight ruby"><code><span class="c1"># users_controller.rb</span>
<span class="k">def</span> <span class="nf">user_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span>
    <span class="ss">:primary_website</span><span class="p">,</span>
    <span class="ss">:secondary_website</span><span class="p">,</span>
    <span class="ss">:optional_website</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
    </article>
  </div>
  <footer>
  <div>Â© 2017 Tirdad C.</div>
  <div>
    <a href="/about/">About</a> |
    <a href="http://stackoverflow.com/users/3102766/tirdadc">Stack Overflow</a> |
    <a href="https://github.com/tirdadc">GitHub</a>
  </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-93236121-1', 'auto');
      ga('send', 'pageview');
    </script>
</footer>

</html>
